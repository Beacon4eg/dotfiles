#!/bin/bash

# Write you devserver here
DEVSERVER="devvm984.cln0.facebook.com"

SCRIPT=`basename $0`
HOST=$1
PORT=${2:-3390}

function error() {
  local code=$1
  local message=$2

  echo -e $message >> /dev/stderr
  exit $code
}

case "$HOST" in
  "-h"|"--help"|"")
    error 1 "Usage: $SCRIPT host [port]";;
  *)
    if [[ $HOST != *".facebook.com"* ]]
	then
		HOST="$HOST.facebook.com"
	fi
    echo -e "RDP: Connecting to $HOST on port $PORT...\n";;
esac

lsof -i tcp:${PORT} | awk 'NR!=1 {print $2}' | xargs kill &> /dev/null
ssh -f -L $PORT:127.0.0.1:$PORT $DEVSERVER "/sbin/fuser -k -TERM -n tcp $PORT; ssh -i ~/local/windows_rsa -L $PORT:127.0.0.1:3389 -N root@$HOST" &> /dev/null
# sleep 5

# osascript <<END
# tell application "Microsoft Remote Desktop"
#     activate
#     tell application "System Events"
#         tell application process "Microsoft Remote Desktop"
#             perform action "AXRaise" of (first window whose name contains "Microsoft Remote Desktop")
#         end tell
#         tell process "Microsoft Remote Desktop"
#             keystroke "f" using {command down}
#             keystroke "a" using {command down}
#             key code 51 --delete
#             delay 0.3
#             keystroke "$PORT" --search query
#             keystroke tab
#             key code 126 --up
#             key code 124 --right
#             key code 125 --down
#             key code 36 --enter
#         end tell
#     end tell
# end tell
# END
