#!/bin/bash

# Write you devserver here
DEVSERVER="devvm4360.lla1.facebook.com"

SCRIPT=`basename $0`
HOST=$1
PORT=${2:-8384}
TARGET_PORT=8384

function error() {
  local code=$1
  local message=$2

  echo -e $message >> /dev/stderr
  exit $code
}

case "$HOST" in
  "-h"|"--help"|"")
    error 1 "Usage: $SCRIPT host [port]";;
  *)
    if [[ $HOST != *".facebook.com"* ]]
	then
		HOST="$HOST.facebook.com"
	fi
    echo -e "Syncthing: Connecting to $HOST on port $PORT...\n";;
esac

lsof -i tcp:${PORT} | grep ssh | awk '{print $2}' | xargs kill &> /dev/null
ssh -f -L $PORT:127.0.0.1:$PORT $DEVSERVER "/sbin/fuser -k -TERM -n tcp $PORT; ssh -i ~/.ssh/windows_id_rsa -L $PORT:127.0.0.1:$TARGET_PORT -N root@$HOST" &> /dev/null
sleep 5
open http://127.0.0.1:$PORT/
